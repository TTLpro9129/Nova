<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>NOVA - Premium Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .loader-card { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        /* Correction Draggable et Souris */
        .draggable { position: fixed; z-index: 100; touch-action: none; cursor: default; }
        .drag-handle { cursor: pointer; user-select: none; }
        /* Style Admin Panel Immobile au Centre */
        #users-panel { position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%); z-index: 60; width: 340px; }
        .custom-select { background: #0f172a; border: 1px solid #1e293b; color: #60a5fa; border-radius: 12px; padding: 8px 16px; outline: none; cursor: pointer; }
        .icon-upload-hover:hover { cursor: pointer; filter: brightness(1.3); transform: scale(1.05); transition: 0.3s; }
    </style>
</head>
<body class="bg-slate-950 text-white font-sans selection:bg-blue-500/30 flex flex-col min-h-screen overflow-x-hidden">

    <nav class="p-6 bg-slate-900 border-b border-slate-800 flex justify-between items-center shadow-2xl sticky top-0 z-50 backdrop-blur-md">
        <h1 class="text-3xl font-black italic text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-green-500 tracking-tighter" data-lang="nav_title">NOVA</h1>
        <div class="flex items-center gap-4">
            {% if user %}
                <span class="text-slate-400 text-xs uppercase font-bold">Account: <b class="text-blue-400" id="current-username">{{ user.username }}</b></span>
                <button onclick="document.getElementById('change-user-modal').style.display='flex'" class="bg-cyan-600/10 text-cyan-400 border border-cyan-600/20 px-4 py-2 rounded-xl text-xs font-black transition hover:bg-cyan-600/20" data-lang="rename">RENAME</button>
                <a href="/logout" class="bg-red-500/10 text-red-500 border border-red-500/20 px-4 py-2 rounded-xl text-xs font-black transition hover:bg-red-500/20" data-lang="logout">LOGOUT</a>
            {% else %}
                <form action="/login" method="post" class="flex gap-2">
                    <input type="text" name="username" placeholder="User" required class="bg-slate-800 px-4 py-2 rounded-xl text-xs border border-slate-700 outline-none w-32 focus:border-blue-500">
                    <input type="password" name="password" placeholder="Pass" required class="bg-slate-800 px-4 py-2 rounded-xl text-xs border border-slate-700 outline-none w-32 focus:border-blue-500">
                    <button type="submit" class="bg-blue-600 px-5 py-2 rounded-xl text-xs font-black hover:bg-blue-500 shadow-lg" data-lang="login">LOGIN</button>
                </form>
                <button onclick="document.getElementById('modal').style.display='flex'" class="text-[10px] text-slate-500 underline font-bold" data-lang="register">REGISTER</button>
            {% endif %}
        </div>
    </nav>

    <main class="container mx-auto p-8 flex-grow">
        <div class="mb-12 flex gap-3">
            <input type="text" id="search-box" data-lang-placeholder="search_ph" placeholder="Search..." class="flex-1 bg-slate-900 px-6 py-5 rounded-[1.5rem] border border-slate-800 outline-none text-sm focus:border-blue-500 transition-all shadow-2xl">
            <button onclick="clearSearch()" class="bg-slate-800 px-8 py-5 rounded-[1.5rem] text-sm font-black hover:bg-slate-700 transition" data-lang="clear">CLEAR</button>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-10" id="apps-grid">
            {% for item in items %}
            <div class="bg-slate-900 border border-slate-800 p-8 rounded-[3rem] relative group hover:border-blue-500 transition-all duration-500 shadow-xl overflow-hidden app-card" data-name="{{ item.name|lower }}">
                <div class="absolute top-6 left-6">
                    <span class="text-[10px] font-black px-3 py-1.5 bg-black/50 rounded-xl {{ item.color }} border border-white/5 uppercase">
                        <i class="{{ item.icon_class }}"></i> {{ item.type }}
                    </span>
                </div>
                {% if item.can_delete %}
                <form action="/delete/{{ item.file }}" method="post" class="absolute top-6 right-6">
                    <button type="submit" class="text-red-500/50 hover:text-red-500 hover:scale-125 transition-all"><i class="fas fa-trash-can"></i></button>
                </form>
                {% endif %}
                <div class="flex flex-col items-center mt-10">
                    <div {% if item.can_delete %} onclick="triggerIconUpload('{{ item.file }}')" class="w-28 h-28 bg-slate-800 rounded-[2.5rem] flex items-center justify-center text-6xl mb-8 {{ item.color }} shadow-2xl transition-all icon-upload-hover overflow-hidden border-4 border-slate-800" 
                         {% else %} class="w-28 h-28 bg-slate-800 rounded-[2.5rem] flex items-center justify-center text-6xl mb-8 {{ item.color }} shadow-2xl overflow-hidden" {% endif %}>
                        {% if item.preview_icon %}
                            <img src="{{ item.preview_icon }}" class="w-full h-full object-cover">
                        {% else %}
                            <i class="{{ item.icon_class if item.icon_class else 'fa-solid fa-box-open' }}"></i>
                        {% endif %}
                    </div>
                    <h3 class="text-xl font-black truncate w-full text-center tracking-tight">{{ item.name }}</h3>
                    <p class="text-slate-500 text-[10px] mb-8 uppercase font-bold opacity-60"><span data-lang="by">By</span> {{ item.owner }}</p>
                    <a href="/download/{{ item.file }}" class="w-full bg-blue-600 text-white font-black py-5 rounded-[1.8rem] flex items-center justify-center gap-3 hover:bg-white hover:text-blue-600 transition-all shadow-xl uppercase tracking-tighter" data-lang="install">INSTALL</a>
                </div>
            </div>
            {% endfor %}
        </div>
    </main>

    <footer class="mt-auto border-t border-slate-900 bg-slate-900/30 p-12 text-center md:text-left">
        <div class="container mx-auto flex flex-col md:flex-row justify-between items-center gap-10">
            <div class="flex flex-col gap-3">
                <p class="text-slate-500 text-[10px] font-black uppercase tracking-[0.4em]" data-lang="built_by">Developer Access</p>
                <a href="https://github.com/TTLpro9129" target="_blank" class="text-blue-400 font-black italic text-2xl hover:text-white transition-all flex items-center gap-3">
                    <i class="fab fa-github text-3xl text-white"></i> TTLpro9129
                </a>
            </div>
            <div class="flex flex-col items-center md:items-end gap-3">
                <p class="text-slate-500 text-[10px] font-black uppercase tracking-[0.4em]" data-lang="lang_title">Region & Language</p>
                <select class="custom-select" id="lang-select" onchange="changeLang(this.value)">
                    <option value="en">English (US)</option>
                    <option value="fr">Français (FR)</option>
                    <option value="es">Español</option>
                </select>
            </div>
        </div>
    </footer>

    <!-- BOUTON UPLOAD : DEPLACABLE -->
    <div id="upload-panel" class="draggable bottom-10 right-10">
        <div id="up-btn-handle" class="drag-handle flex flex-col items-center justify-center w-24 h-24 bg-gradient-to-tr from-blue-600 to-green-500 rounded-full shadow-[0_0_30px_rgba(59,130,246,0.5)] border-4 border-slate-950 transition-all active:scale-95 group">
            <i class="fas fa-cloud-upload-alt text-3xl text-white group-hover:animate-bounce"></i>
            <span class="text-[9px] font-black text-white mt-1 uppercase" data-lang="upload">Upload</span>
        </div>
        <!-- Support archives ajouté -->
        <input id="f" type="file" name="file" class="hidden" accept=".exe,.apk,.ipa,.msi,.deb,.sh,.bat,.zip,.rar,.7z" onchange="handleInstantUpload(this)">
    </div>

    <!-- ADMIN PANEL -->
    {% if user and user.is_admin %}
    <div id="users-panel" class="bg-slate-900 border border-slate-800 rounded-[2.5rem] shadow-2xl overflow-hidden no-select">
        <div id="users-panel-header" class="px-8 py-5 border-b border-slate-800 flex items-center justify-between bg-white/5 cursor-pointer" onclick="toggleUsersPanel()">
            <div class="flex items-center gap-3 text-xs text-white font-black uppercase"><span data-lang="members">Members</span> ({{ users|length }})</div>
            <i id="users-toggle-icon" class="fas fa-chevron-up text-slate-500"></i>
        </div>
        <div id="users-body" class="max-h-64 overflow-y-auto p-4 space-y-2" style="display: none;">
            {% for u in users %}
            <div class="px-4 py-3 flex items-center justify-between hover:bg-white/5 rounded-2xl transition-all">
                <div class="text-sm font-bold truncate text-slate-300">{{ u.username }}</div>
                <div class="flex items-center gap-2">
                    <button onclick="openAdminRenameModal('{{ u.username }}')" class="text-cyan-400 text-xs font-black uppercase hover:underline">Rename</button>
                    <form method="post" action="/admin/delete_user"><input type="hidden" name="target" value="{{ u.username }}"><button type="submit" class="text-red-500 px-2 font-black">X</button></form>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- MODAL -->
    <div id="modal" class="hidden fixed inset-0 bg-black/90 z-[120] items-center justify-center p-4">
        <div class="bg-slate-900 p-12 rounded-[4rem] border border-slate-700 w-full max-w-sm text-center shadow-2xl">
            <h2 class="text-3xl font-black mb-10 text-white uppercase tracking-tighter" data-lang="join_hub">Join Nova</h2>
            <form action="/register" method="post" class="space-y-6">
                <input type="text" name="username" placeholder="Username" required class="w-full bg-slate-800 p-6 rounded-3xl border border-slate-700 outline-none">
                <input type="password" name="password" placeholder="Password" required class="w-full bg-slate-800 p-6 rounded-3xl border border-slate-700 outline-none">
                <button type="submit" class="w-full bg-green-600 py-6 rounded-3xl font-black text-xl hover:bg-green-500 transition" data-lang="create_acc">REGISTER</button>
            </form>
        </div>
    </div>

    <!-- MODAL RENAME PERSONNEL -->
    <div id="change-user-modal" class="hidden fixed inset-0 bg-black/90 z-[120] items-center justify-center p-4">
        <div class="bg-slate-900 p-12 rounded-[4rem] border border-slate-700 w-full max-w-sm text-center shadow-2xl">
            <h3 class="text-2xl font-black mb-8 text-cyan-400 uppercase tracking-tight">Rename Profile</h3>
            <form action="/change_username" method="post" class="space-y-6">
                <input type="text" name="new_username" placeholder="New username" required class="w-full bg-slate-800 p-6 rounded-3xl border border-slate-700 outline-none focus:border-cyan-500">
                <button type="submit" class="w-full bg-cyan-600 py-6 rounded-3xl font-black text-xl hover:bg-cyan-500 transition active:scale-95 tracking-widest" data-lang="update">UPDATE</button>
            </form>
        </div>
    </div>

    <!-- Support GIF ajouté -->
    <input type="file" id="icon-input" class="hidden" accept="image/*,.gif" onchange="handleIconUpload(this)">

    <script>
        const translations = {
            en: { nav_title: "NOVA", rename: "RENAME", logout: "LOGOUT", login: "LOGIN", register: "REGISTER", search_ph: "Search...", clear: "CLEAR", by: "By", install: "INSTALL", built_by: "Developer Access", lang_title: "Region & Language", upload: "Upload", members: "Members", join_hub: "Join Nova", create_acc: "REGISTER", update: "UPDATE" },
            fr: { nav_title: "NOVA", rename: "RENOMMER", logout: "QUITTER", login: "ENTRER", register: "S'INSCRIRE", search_ph: "Chercher...", clear: "EFFACER", by: "Par", install: "INSTALLER", built_by: "Accès Développeur", lang_title: "Région & Langue", upload: "Publier", members: "Membres", join_hub: "Rejoindre Nova", create_acc: "S'INSCRIRE", update: "MODIFIER" },
            es: { nav_title: "NOVA", rename: "RENOMBRAR", logout: "SALIR", login: "ENTRAR", register: "REGISTRO", search_ph: "Buscar...", clear: "LIMPIAR", by: "Por", install: "INSTALAR", built_by: "Acceso Desarrollador", lang_title: "Región e Idioma", upload: "Subir", members: "Miembros", join_hub: "Unirse a Nova", create_acc: "REGISTRO", update: "ACTUALIZAR" }
        };
        function changeLang(l) { localStorage.setItem('hub_lang', l); document.querySelectorAll('[data-lang]').forEach(el => { el.innerText = translations[l][el.getAttribute('data-lang')] || el.innerText; }); document.querySelectorAll('[data-lang-placeholder]').forEach(el => { el.placeholder = translations[l][el.getAttribute('data-lang-placeholder')] || el.placeholder; }); }
        changeLang(localStorage.getItem('hub_lang') || 'en');

        // Draggable Logic
        function makeDraggable(elementId, handleId) {
            const el = document.getElementById(elementId);
            const handle = document.getElementById(handleId) || el;
            if (!el) return;
            let ox, oy, isDrag = false, startX, startY;
            handle.onmousedown = (e) => {
                isDrag = false; startX = e.clientX; startY = e.clientY;
                const rect = el.getBoundingClientRect();
                ox = e.clientX - rect.left; oy = e.clientY - rect.top;
                document.onmousemove = (ev) => {
                    const dist = Math.hypot(ev.clientX - startX, ev.clientY - startY);
                    if (dist > 5) { isDrag = true; el.style.bottom = 'auto'; el.style.right = 'auto'; el.style.left = (ev.clientX - ox) + 'px'; el.style.top = (ev.clientY - oy) + 'px'; }
                };
            };
            document.onmouseup = (e) => {
                document.onmousemove = null;
                const dist = Math.hypot(e.clientX - startX, e.clientY - startY);
                if (dist < 5 && elementId === 'upload-panel') { 
                    if(document.getElementById('current-username')) document.getElementById('f').click();
                    else alert("Login first!");
                }
            };
        }
        makeDraggable('upload-panel', 'up-btn-handle');

        async function handleInstantUpload(input) {
            const file = input.files[0]; if (!file) return;
            const grid = document.getElementById('apps-grid');
            const ghost = document.createElement('div');
            ghost.className = "bg-slate-900 border border-blue-500 p-8 rounded-[3rem] relative loader-card shadow-2xl opacity-50";
            
            // AJOUT DU TEXTE D'ATTENTE
            ghost.innerHTML = `
                <div class="absolute top-6 left-6"><span class="text-[10px] font-black px-3 py-1.5 bg-blue-600 rounded-xl text-white uppercase flex items-center gap-2"><i class="fas fa-spinner fa-spin"></i> PUBLISHING...</span></div>
                <div class="flex flex-col items-center mt-10">
                    <div class="w-28 h-28 bg-slate-800 rounded-[2.5rem] flex items-center justify-center text-6xl mb-8 text-blue-400 shadow-2xl"><i class="fa-solid fa-cloud-arrow-up"></i></div>
                    <h3 class="text-xl font-black truncate w-full text-center">${file.name.split('.')[0]}</h3>
                    <p class="text-slate-500 text-[10px] mb-2 uppercase opacity-60">Wait...</p>
                    <p class="text-[9px] text-blue-400 font-bold uppercase text-center px-4 leading-tight opacity-80">This may take some time depending on file size.</p>
                </div>`;
            
            grid.insertBefore(ghost, grid.firstChild);
            const formData = new FormData(); formData.append('file', file);
            try { 
                const res = await fetch('/upload', { method: 'POST', body: formData }); 
                if (res.ok) window.location.reload(); 
                else { const d = await res.json(); alert("Error: " + d.error); ghost.remove(); }
            } catch (e) { ghost.remove(); }
        }

        let targetIconFile = "";
        function triggerIconUpload(filename) { targetIconFile = filename; document.getElementById('icon-input').click(); }
        async function handleIconUpload(input) {
            if (!input.files[0] || !targetIconFile) return;
            const formData = new FormData(); formData.append('image', input.files[0]);
            try { await fetch(`/update_icon/${targetIconFile}`, { method: 'POST', body: formData }); window.location.reload(); } catch (e) { console.error(e); }
        }

        function clearSearch() { document.getElementById('search-box').value = ''; document.querySelectorAll('.app-card').forEach(c => c.style.display = ''); }
        function toggleUsersPanel(){ 
            const b = document.getElementById('users-body'); 
            const icon = document.getElementById('users-toggle-icon');
            if(b.style.display === 'none') { b.style.display = 'block'; icon.className = 'fas fa-chevron-down'; }
            else { b.style.display = 'none'; icon.className = 'fas fa-chevron-up'; }
        }
        document.getElementById('search-box').onkeyup = function() {
            const s = this.value.toLowerCase();
            document.querySelectorAll('.app-card').forEach(c => c.style.display = c.dataset.name.includes(s) ? '' : 'none');
        };
    </script>
</body>
</html>